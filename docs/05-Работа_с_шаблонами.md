# Работа с шаблонами

Система шаблонов в GSConfig позволяет генерировать структурированные конфигурационные файлы на основе данных, полученных из Google Sheets. Шаблоны особенно полезны, когда требуется преобразовать данные в специфический формат для использования в игровых движках.

## Класс Template

`Template` - основной класс для работы с шаблонами. Он загружает шаблон из файла и заполняет его данными с помощью метода `render()`.

```python
class Template(object):
    def __init__(self, path='', body='', pattern=None, strip=True, jsonify=False):
        """
        Инициализация шаблона

        :param path: путь к файлу шаблона
        :param body: шаблон в виде строки (альтернатива path)
        :param pattern: паттерн для поиска переменных в шаблоне
        :param strip: отрезать ли кавычки от строк при подстановке
        :param jsonify: преобразовывать ли результат в JSON объект
        """
```

Пример использования:

### Шаблон из файла

Предположим, у нас есть шаблон `MobSettings.template`:

```json
{
  "_maxHealth": {% health!float %},
  "_botRewards": {% bot_rewards %},
  "RectilinearCowardlyStateSettings": {
    "DelayCaptured": {% captured_delay!int %}
  }
}
```

Код для загрузки и заполнения шаблона:

```python
import gsconfig

# Создание шаблона из файла
template = gsconfig.Template('templates/MobSettings.template')

# Данные для заполнения шаблона
data = {
    'health': 100,
    'bot_rewards': {'gold': 10},
    'captured_delay': 2.7  # будет преобразовано в 2 командой int
}

# Заполнение шаблона данными
result = template.render(data)

# Сохранение результата в файл
gsconfig.tools.save_json(result, 'SheepSettings', 'json')
```

Результат:
```json
{
  "_maxHealth": 100.0,
  "_botRewards": {"gold": 10},
  "RectilinearCowardlyStateSettings": {
    "DelayCaptured": 2
  }
}
```

### Шаблон из строки

Вы также можете передать шаблон напрямую в виде строки:

```python
import gsconfig

# Шаблон в виде строки
template_body = """
{
  "name": "{% monster_name %}",
  "stats": {
    "health": {% health!float %}
  }
}
"""

# Создание шаблона из строки
template = gsconfig.Template(body=template_body, jsonify=True)

# Данные для заполнения шаблона
data = {
    'monster_name': 'Goblin',
    'health': 50
}

# Заполнение шаблона данными и получение результата как JSON
result = template.render(data)
print(result)
```

Результат:
```json
{
  "name": "Goblin",
  "stats": {
    "health": 50.0
  }
}
```

## Команды в ключах шаблона

В шаблонах можно использовать команды для преобразования значений при подстановке. Команды указываются после ключа через символ `!`:

```
{key!command}
```

Например:
```
{health!float}
```

### Команды

- **float** - преобразует значение в число с плавающей запятой
  ```
  {speed!float}  # 10 -> 10.0
  ```
- **int** - преобразует значение в целое число, отбрасывая дробную часть
  ```
  {health!int}  # 10.9 -> 10
  ```
- **json** - сохраняет структуру как JSON (применяет json.dumps())
  ```
  {stats!json}  # {"health": 100} -> "{\"health\": 100}"
  ```
- **list** - заворачивает значение в список, если оно еще не является списком
  ```
  {weapon!list}  # "sword" -> ["sword"], [1, 2] не изменяется
  ```
- **extract** - извлекает элемент из списка, если это список единичной длины
  ```
  {item!extract}  # [{"name": "sword"}] -> {"name": "sword"}
  ```
- **wrap** - заворачивает в дополнительный список, если первый элемент не список
  ```
  {items!wrap}  # [1, 2, 3] -> [[1, 2, 3]]
  ```
- **string** - принудительно заворачивает строку в кавычки
  ```
  {name!string}  # John -> "John"
  ```
- **get_N** - получает элемент из списка по индексу N
  ```
  {items!get_2}  # ["a", "b", "c"] -> "c"
  ```
- **extract_N** - получает элемент из списка по индексу N (аналогично get_N)
  ```
  {items!extract_1}  # ["a", "b", "c"] -> "b"
  ```
- **none** или **null** - возвращает None для пустых строк
  ```
  {empty_value!none}  # "" -> null в JSON
  ```

### Цепочки команд

Команды можно объединять в цепочки, применяя их последовательно:

```
{% characters!get_1!float %}
```

Такая конструкция последовательно применяет команды слева направо:
1. Получит первый элемент (`get_1`) из списка `items`
2. Переведет получившееся значение во (`float`)

Данные:

```python
data = {
    'characters': ['knight', 100, 'sword']
}
```

И шаблон с цепочкой команд:

```json
{
  "warrior_health": {% characters!get_1!float %}
}
```

Пошаговое выполнение цепочки команд:

- Исходное значение: `['knight', 100, 'sword']`
- `get_1` вернёт `100`
- `float` преобразует полученное значение в `100.0`

Результат:

```json
{
  "warrior_health": 100.0
}
```

### Кастомные команды в ключах шаблона

См. раздел [Кастомные расширения](07-Кастомные_расширения.md)

## Команды управления строками шаблона

Шаблоны поддерживают специальные команды для управления строками:

### if

Сохраняет блок между `if` и `endif`, если условие истинно (`has_weapon = True`):

```
{% if has_weapon %}
"weapon": {
  "name": "{% weapon_name %}",
  "damage": {% weapon_damage!int %}
},
{% endif %}
```

### foreach

Цикл. Повторяет блок между `foreach` и `endforeach`.

Команда `foreach` обходит элементы в списке, указанном в параметре (`drops` в примере ниже). Для итерации по элементам используется зарезервированная переменная `$item`, которая внутри блока заменяется на текущий элемент списка.

Шаблон:

```json
{
  "monster": {
    "name": "Dragon",
    "drops": [
    {% foreach drops %}
      {
        "item": "{% $item!get_0 %}"
      }
    {% endforeach %}
    ]
  }
}
```

Для данных:
```python
data = {
    'drops': [
        ['sword', 0.5, 1],
        ['shield', 0.3, 1],
        ['potion', 0.7, 2]
    ]
}
```

Результат будет:
```json
{
  "monster": {
    "name": "Dragon",
    "drops": [
      {
        "item": "sword"
      },
      {
        "item": "shield"
      },
      {
        "item": "potion"
      }
    ]
  }
}
```

#### Особенности работы с переменной $item:

Когда элемент списка является простым типом (строка или число), то `$item` напрямую заменяется на значение этого элемента
  ```python
  # Если drops = ['sword', 'shield', 'potion']
  {% foreach drops %}
    "item_$item",  # Результат: "item_sword", "item_shield", "item_potion"
  {% endforeach %}
  ```

Для структур список и словарь `$item` заменяется конструкцией, позволяющей обратиться к элементу через индекс
  ```python
  # Если drops = [['sword', 0.5, 1], ['shield', 0.3, 1], ['potion', 0.7, 2]]
  {% foreach drops %}
    {
      "item": "{% $item!get_0 %}",  # Обращение к первому элементу текущего вложенного списка
      "chance": {% $item!get_1!float %},
      "count": {% $item!get_2!int %}
    }
  {% endforeach %}
  ```

Система автоматически удаляет последнюю запятую в генерируемом списке, что полезно при создании JSON-структур

### for

Повторяет блок между `for` и `endfor` заданное количество раз.

Команда `for` выполняет цикл заданное количество раз, определяемое числовым значением параметра (например, `spawn_count`). Внутри блока доступна зарезервированная переменная `$i`, которая содержит текущий индекс итерации.

Шаблон:

```json
{
  "spawn_points": [
  {% for spawn_count %}
    {
      "x": {% spawn_x!get_$i!float %}
    }
  {% endfor %}
  ]
}
```

Для данных:
```python
data = {
    'spawn_count': 3,
    'spawn_x': [10.5, 20.3, 15.7]
}
```

Результат будет:
```json
{
  "spawn_points": [
    {
      "x": 10.5
    },
    {
      "x": 20.3
    },
    {
      "x": 15.7
    }
  ]
}
```

#### Особенности использования переменной $i:

Переменная `$i` принимает значения от 0 до n-1, где n - значение параметра `spawn_count`
  ```
  # Если spawn_count = 3
  {% for spawn_count %}
    "position_$i",  # Результат: "position_0", "position_1", "position_2"
  {% endfor %}
  ```

Переменная `$i` особенно полезна для доступа к элементам массивов по индексу:
  ```
  # Если spawn_x = [10.5, 20.3, 15.7] и spawn_count = 3
  {% for spawn_count %}
    {
      "x": {% spawn_x!get_$i!float %},  # Получаем элемент из spawn_x с индексом 0, 1, 2
    },
  {% endfor %}
  ```

Можно комбинировать несколько массивов для создания структурированных данных
  ```
  # Если spawn_x = [10.5, 20.3, 15.7], spawn_y = [5.1, 8.4, 3.2], spawn_count = 3
  {% for spawn_count %}
    {
      "x": {% spawn_x!get_$i!float %},
      "y": {% spawn_y!get_$i!float %}
    }
  {% endfor %}
  ```

Так же как и в случае с `foreach`, система автоматически удаляет последнюю запятую в генерируемом списке

## Комментарии в шаблонах

GSConfig поддерживает два способа добавления комментариев в шаблоны:

### Однострочные комментарии

Для добавления однострочных комментариев используется синтаксис:

```
{# Это комментарий, который будет удален при обработке шаблона #}
```

Пример использования однострочных комментариев:

```
{
  "_maxHealth": {health!float}, {# Максимальное здоровье моба #}
  "_timeToStartRegeneration": {time_before_regen!float}, {# Время до начала регенерации #}
  "_regenerationSpeed": {regen_speed!float} {# Скорость регенерации здоровья #}
}
```

### Многострочные комментарии

Для многострочных комментариев используется команда `comment`:

```
{% comment %}
Это многострочный комментарий,
который будет удален при обработке шаблона.
Удобно для временного отключения
больших блоков шаблона.
{% endcomment %}
```

Пример использования многострочных комментариев:

```
{
  "_mainSettings": {
    "health": {health!float},
    "speed": {speed!float}
  },
  
  {% comment %}
  Этот блок с дополнительными параметрами
  временно отключен, так как требует доработки
  "_additionalSettings": {
    "armor": {armor!float},
    "resistance": {resistance!float}
  },
  {% endcomment %}
  
  "_visualSettings": {
    "scale": {scale!float}
  }
}
```

Оба типа комментариев полностью удаляются в процессе обработки шаблона и не попадают в итоговый результат.

### Кастомные команды управления строками

См. раздел [Кастомные расширения](07-Кастомные_расширения.md)